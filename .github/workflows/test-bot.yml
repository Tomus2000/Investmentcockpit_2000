name: Test Telegram Bot

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'bot.py'
      - '.github/workflows/test-bot.yml'
  schedule:
    # Run daily at 8:50 AM UTC (9:50 AM Lisbon time) to test before scheduled messages
    - cron: '50 8 * * *'

jobs:
  test-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements_bot.txt
    
    - name: Send Telegram Messages
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_USER_ID: ${{ secrets.TELEGRAM_USER_ID }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "üöÄ Sending portfolio summary and recommendations..."
        python test_bot_now.py
    
    - name: Test portfolio functions
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        python -c "
        import os
        import sys
        sys.path.insert(0, '.')
        
        # Import bot functions
        from bot import load_portfolio_from_supabase, get_supabase_client
        
        supabase = get_supabase_client()
        if supabase:
            print('‚úÖ Supabase client created')
            portfolio = load_portfolio_from_supabase()
            print(f'‚úÖ Portfolio loaded: {len(portfolio)} positions')
        else:
            print('‚ö†Ô∏è Supabase client not available (check credentials)')
        "

